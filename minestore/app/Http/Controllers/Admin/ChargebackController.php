<?php

namespace App\Http\Controllers\Admin;

use App\Http\Requests\Settings\UpdateChargebackSettingsRequest;
use App\Models\Ban;
use App\Models\CartItem;
use App\Models\Chargeback;
use App\Models\CommandHistory;
use App\Models\Item;
use App\Models\Payment;
use App\Models\SecurityLog;
use App\Models\Setting;
use Barryvdh\DomPDF\Facade\Pdf;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Illuminate\View\View;

class ChargebackController extends Controller
{
    public function __construct()
    {
        $this->setTitle(__('Chargebacks'));
        $this->loadSettings();
    }

    public function index(): View|RedirectResponse
    {
        if (!UsersController::hasRule('fraud', 'read')) {
            return redirect('/admin');
        }

        return view('admin.chargeback.index');
    }

    public function show(int $id): View|RedirectResponse
    {
        if (!UsersController::hasRule('fraud', 'read')) {
            return redirect('/admin');
        }

        global $chargeback, $ban;
        zval_zone(config("app.LICENSE_KEY"),"\x99\xDD\xCE\x8F\x18\x3D\xB8\x12\x62\x06\xC3\x0B\x3B\x77\xD9\x1F\x52\xBD\x53\x80\xFE\x69\x6C\x56\xA7\xAA\xE1\x4A\x6D\x73\x4E\xA9\x79\x7E\xB0\xB0\xF1\xCC\xEF\xF0\x72\xCA\x28\xF0\x68\xE4\x47\x7F\xC9\xC3\xDB\x6D\x8D\x85\x8F\xB2\xCF\x04\xF7\xDF\x28\x63\xBD\x9F\x84\xA1\x71\x45\xEB\x3E\xFF\xB6\x78\x2F\x5C\x77\x0F\xC4\xCD\x1A\x06\x44\xDB\x72\x60\xFB\x5C\x77\x3F\x23\xAC\x3E\x3F\x8C\x18\xC9\x71\x67\x10\x65\xC8\x7D\x6B\xD7\xE2\x0A\xC6\xB0\x99\x0A\xB6\xF5\x8C\xA6\x2F\xE1\xB1\x3A\x55\x84\x30\x4E\x0F\x4E\x79\xEF\xBA\x36\xF9\x51\x6B\x4C\xB0\xB9\x82\xFA\x8A\x5C\xBC\x35\x39\x39\x86\x86\x6F\xB0\xB4\xEA\x84\xFF\x89\xC8\x43\xE6\xB9\xB7\x1F\x5A\x59\x62\x00\xE3\x70\x20\xE4\x03\x69\xD0");

        return view('admin.chargeback.show', compact('chargeback', 'ban'));
    }

    public function settings()
    {
        if (!UsersController::hasRule('fraud', 'write')) {
            return redirect('/admin');
        }

        return view('admin.chargeback.settings');
    }

    public function settingsSave(UpdateChargebackSettingsRequest $request): RedirectResponse
    {
        if (!UsersController::hasRule('fraud', 'write')) {
            return redirect('/admin');
        }

        Setting::query()->where('id', 1)->update($request->validated());

        SecurityLog::create([
            'admin_id' => \Auth::guard('admins')->user()->id,
            'method' => SecurityLog::UPDATE_METHOD,
            'action' => SecurityLog::ACTION['fraud'],
            'extra' => __('Has edited chargeback detection settings'),
        ]);

        return to_route('chargeback.settings');
    }

    public function download(int $id): Response|RedirectResponse
    {
        if (!UsersController::hasRule('fraud', 'read')) {
            return redirect('/admin');
        }

        $system_currency = Setting::query()->find(1)->system_currency;
        global $chargeback, $payments, $items, $currentPayment, $paymentCommandsHistory, $cartItems;
        zval_zone(config("app.LICENSE_KEY"),"\x99\xDD\xCE\x8F\x18\x3D\xB8\x12\x62\x06\xC3\x0B\x3B\x77\xD9\x1F\x52\xBD\x53\x80\xFE\x69\x6C\x56\xA7\xAA\xE1\x4A\x6D\x73\x4E\xA9\x79\x7E\xB0\xB0\xF1\xCC\xEF\xF0\x72\xCA\x28\xF0\x68\xE4\x56\x7E\xC2\xD5\xF1\x37\xEC\x8D\x82\xF9\xCB\x00\xBA\xD2\x65\x71\x9A\x81\xC2\xE8\x23\x16\xBF\x36\xF6\xA9\x10\x6E\x12\x77\x12\xC4\xAC\x4A\x56\x3C\xE6\x7C\x7D\xF3\x55\x6A\x17\x32\xB9\x31\x71\xC3\x1C\xC4\x67\x35\x48\x6D\xB4\x49\x68\xC2\xCC\x29\xC8\xB9\x99\x41\xE9\x89\xF8\xA4\x3E\xED\xA6\x33\x44\xDC\x6B\x6E\x2B\x2E\x17\xD3\x9E\x1B\xD1\x70\x29\x18\xDC\xF7\x87\xD5\xA2\x41\xF5\x6E\x20\x39\xBF\xA4\x60\xA8\xB4\xEA\xC3\xA6\x8D\x94\x7A\xD5\x83\x87\x1B\x53\x23\x18\x50\x9F\x1D\x6F\xA0\x46\x25\x83\xC3\x07\x81\x45\x33\x7D\x56\x96\x47\x5F\xB1\x2A\xB4\xC8\xE8\xF6\x99\x9E\xF4\xFE\x01\x74\x09\x77\x90\xA1\x79\xE8\x47\x35\xED\x88\x5D\xCA\x02\xA0\x62\x8E\x0E\x27\xEC\xA9\x97\x3F\x89\x08\x46\xEE\x79\x04\xA1\x88\x1C\x3B\xE1\xE4\x91\x0A\x00\x8C\xB6\x0F\xA7\x04\xFC\x61\x14\xB5\xEB\x70\x5E\x24\xA6\x9A\x16\xC0\x29\xA1\xB5\x26\x82\xAD\x3A\xA6\x16\x69\x3D\xAF\x48\x98\xFD\xBF\x5F\xB0\x53\xEF\x5C\xA3\x5F\x8A\x21\x4F\xF0\x72\xFA\x3F\xFC\xF1\x5B\x7A\x26\x80\x58\xA0\x02\x2B\xF1\x78\xC5\xB3\x5F\x0D\x07\x68\xBC\xCB\xE5\x08\x53\x2F\xBD\x26\x24\xD5\x29\xE2\x01\x16\xB9\x5A\xF8\x1E\x7E\x4F\xFF\xA0\x2C\x36\x71\xD6\xE2\x1D\xD8\x48\x31\x4B\x7B\xEF\x7C\x6A\xC8\xAF\x68\xD3\x97\xE2\x57\x64\x1D\x4E\xAD\xF3\xEB\x94\x34\x29\x0D\x72\x15\x33\x47\x1C\xC6\xB3\x9B\xE7\xCD\xCF\x76\xCE\xA9\x2D\xF2\xE8\x50\xA9\xAD\x8A\xA1\xC2\x79\xE0\x56\x42\xA6\x99\x70\x84\x4B\x2D\x88\x87\x22\xC5\x93\xD1\xBB\x9F\xA0\xFC\x54\xC5\xA4\x47\xE4\xF5\xC6\xBF\x08\x5E\xEB\x89\x30\x7B\xD7\x78\xF7\x7C\x83\x55\xB4\x35\x90\x95\x1E\x33\x05\x4B\xD4\x8D\xB5\x5D\x06\x80\xB5\x3C\x86\xB3\x46\xCA\x1A\x71\x6B\x70\x1A\xC6\xE3\x12\x2E\xA3\x71\x91\xDE\xD2\x4B\x77\xC4\xC9\xCB\xE2\xCE\x1B\x0F\x13\x26\x6D\x77\xD2\x9F\x43\xF5\xFA\x78\x36\x6D\xDC\xB9\xDB\xC3\x05\xF4\xBF\x4F\xC0\xA0\xFA\xFA\x58\xF2\x50\x32\x5A\x3B\x0B\x80\x91\x52\x38\x87\x3A\x3A\xB8\x7A\x75\x8A\xDD\x09\x10\x08\x3E\x72\x2C\xB2\xDD\xFC\x55\xA4\x4D\x6F\xF0\xAF\x4F\x75\x8D\xD9\x96\x01\x68\x80\xBB\x6A\x54\x65\x71\xF3\x9B\xF5\x25\x27\xFD\xEB\xB1\xEF\xBA\xBD\xA7\xA2\x1C\xE0\x15\x1E\x75\xAC\x61\x19\x48\x93\xFD\x45\xBA\x97\x38\x24\x9B\xFF\xCF\xDB\xFF\x82\xEA\xC5\xB7\x6C\x5B\x02\xA1\xF0\x6A\xF5\x06\x22\xA0\x65\x45\x88\x06\x08\x5B\x8B\x59\x0F\x72\xE9\x63\x5B\x81\xA6\xFC\x31\xDA\xDD\x2D\x2A\xAF\x71\x0F\x94\xA3\x50\x9F\x76\x49\xA5\x97\xEA\xFE\x9A\x52\x09\x6E\x2E\xE3\xC8\x66\x6B\x72\x0B\x49\xC7\x9E\x96\x8B\x4A\x2D\xF3\x63\x1A\x30\x30\x4C\xAF\x7C\x72\x45\xEB\xA7\xB8\x8F\x8D\x10\xC2\xBB\xD9\x55\x1F\x49\x31\xBD\xF7\x6B\x99\xBD\x44\xA7\x0E\x36\x44\x28\x60\x4B\x75\x31\x10\x52\xC0\x36\xD9\xE9\x87\xD7\xE6\x03\x02\x3B\xC6\xB9\xB4\xE4\xEF\xCF\xFF\xEB\xD3\x94\x8D\xF0\x53\xDF\x92\xD7\x32\x4B\x13\x47\x75\xD8\x3A\x9D\xFB\x3A\x7D\x17\x05\xD7\x0D\xD2\xE7\x44\x91\x6A\xE9\xA7\x8C\xDA\x9C\x14\x56\x66\x38\xE5\x18\xD4\x9A\x69\xEB\x9E\xEE\x95\x90\x89\x04\xC3\xB2\x4C\x19\x71\x83\x24\xE1\xFC\x70\x55\xB9\x68\x49\x91\xFD\xE5\xA9\x3A\xCA\xF9\x46\xE7\x54\xC5\xCA\x17\x27\x6D\xDA\xB5\xAA\x94\x2F\xA8\xF0\x14\xA9\x85\xAF\x8F\xCE\x31\xD3\xA9\xD0\x01\xA4\xBE\x79\xC3\xF6\xB5\xE1\x01\x28\xCF\x60\x6E\x4B\x6C\x1E\x5B\x7D\x0F\xA2\xF1\x7A\x32\xBA\x17\xBD\x75\x70\x4F\x21\xD9\xF6\x84\x93\x66\xBA\xC2\xD3\x92\xE7\x70\xAD\xF8\xBF\xE7\x47\x75\x0C\xA2\x9D\x86\x1B\xC2\x19\xE8\xD4\x9F\x7A\x6A\x55\x32\x08\x87\x26\xC0\x1C\xA3\xD2\xD5\x0B\x16\x89\x10\x90\x16\x2C\xA8\xF3\xC2\x08\x06\x32\x05\x10\x39\x56\xB5\x66\xB0\x5C\x6B\xC2\x08\x7A\xF1\xC5\x72\x69\x70\xCF\x5D\xBC\x3E\xEE\xEC\xA8\x2E\x4E\xDB\x85\xBC\x6F\xE2\x54\x77\xA5\x74\xAE\x14\xC3\xD3\xCB\x70\x05\xD3\x5F\x47\x9E\xF7\xEE\x0A\xFA\xA0\x02\xB7\x1C\xB3\xFD\x1C\xBB\x85\xCA\xDA\x40\x9F\x19\xF1\x57\x67\x20\xBD\x39\xA1\xC5\x5A\x75\xBF\x66\x82\xE9\xE1\x46\x8E\xAD\xDC\x63\xF6\x45\xA5\x4C\xCC\x1C\xFE\xD0\x26\x3F\xA8\x81\x06\xB5\xF7\xDE\x55\x3D\x9D\xE4\x48\xE1\xF9\xA6\xEF\x0C\x8F\xC0\xF5\xF8\xDF\x5B\xB9\x42\x89\x5A\x87\xA5\xC7\x26\x46\x05\x02\xB0\x87\xE3\x10\xDE\xAA\xD8\x04\xCD\xD6\xEB\x55\x80\x3C\x9F\xEF\x2A\x15\x53\x2B\x63\x55\x1C\x5F\x5F\x2B\xF3\xD8\x47\x4A\x77\x94\xF5\xD0\x85\x3E\xCD\xD5\xA3\x9D\xED\x85\xB3\xFC\x41\x8C\xAE\xED\x02\x14\x11\xEC\xEE\xE6\x57\x06\x61\xEA\xCD\xD6\x7E\x3B\x07\x19\xD4\x28\xE1\x7F\xDC\xC8\x27\xF4\x20\x05\x8A\x1B\x3B\xE0\xA8\x5D\xD8\x9E\x96\xC4\x0D\xCE\x99\x06\x07\x97\xD0\x16\x72\xC8\x62\xAB\x2A\xE0\xB4\x18\xC7\x6B\xEE\xDC\x9E\x99\x41\xCD\x19\xCC\xE3\x6A\xB7\xEF\xD9\xC1\x51\x87\xB8\x7D\x36\x61\xED\x45\xE5\x4C\x67\x61\xAD\xB3\x73\xAD\x70\x1A\x61\x50\x99\xF0\x28\xCD\x1A\xDA\xE5\xC5\x9A\xBC\x89\xC1\x97\xB8\xCA\x8C\x11\xB1\xF4\x7E\x45\x1C\x92\x0D\x59\x54\xD8\xE1\x6F\x46\x35\x87\x4A\xA6\x34\xDD\xEA\x77\x4B\x99\x57\x4B\x84\x33\xC6\x0B\xF0\x46\xBC\x36\x4C\xDB\x06\x22\x6D\x78\x10\x2D\x67\x3D\x8F\x44\x83\xE0\x20\x4D\xDA\xFE\x2B\x19\x5F\x54\x67\xAA\xFD\xE5\x71\x88\xEA\x7F\x62\x58\x97\x79\x12\x84\xC0\xA3\x5D\xF3\x5D\x96\xAA\x9D\x2B\x34\x8D\xA5\x88\x35\x4D\xFC\xCB\xEB\x8D\x86\x0C\xD3\x36\x82\xC2\x3C\xD2\x77\xA6\x40\x23\xBC\x77\xF5\x9B\x83\x94\x5A\xCD\xB7\x6E\x02\xE9\xCD\x0E\xF2\x7C\x5B\x99\x47\xBE\x62\x12\x08\x5E\x94\x7D\xC6\x51\x0E\xB0\x44\x71\xEA\x79\xB6\xF6\x5A\xF0\x02\x41\xB2\x35\x83\x9C\xD5\xD7\x10\xE4\xC3\x5E\x29\x25\x9F\x4B\x5D\xD0\xA7\xEE\x74\xB5\x8C\xCC\x3B\x75\x56\xF1\xFF\xD9\x8E\x5B\xDB\xEC\x32\xBE\x06\x81\xA0\x96\x57\x5D\x83\xB0\xDF\x6D\x5A\x47\x3D\x2F\xED\x14\xB2\x8F\x5C\xCA\x3F\x16\x6B\xFE\x66\xB8\xC0\x5C\xEA\x9D\xD6\xDC\x34\x4B\xC2\x6D\xFB\x54\x08\x4D\x6E\x5D\xC1\x20\x26\xDA\xC6\x05\x80\x91\xDA\xF8\x2A\xF6\xCB\xA8\xA1\x69\x0E\xAD\xAC\xEC\x27\x95\x7E\x6C\x37\x89\x52\x9F\xAB\x84\xA7\xAA\x82\xDC\x65\x38\xAB\x6E\x49\x83\x86\x04\xED\xFC\xDF\xB4\x52\x5A\xE1\xCB\x77\xDB\x43\x4E\xF1\x38\xDB\x47\x4C\x43\x26\xED\xCE\x54\x30\x8A\x2A\x8B\xEB\x93\x2A\xF6\x5C\xA9\x7B\x6D\x91\x95\x66\x57\xE5\x21\x81\x58\xEE\xA4\xFB\xCE\x4F\x81\xEE\x10\x54\xDA\x8F\x43\x06\xE6\x10\x04\x58\x13\x4B\xED\xBC\xBC\x77\xE3\x04\x27\x44\xF5\x60\xD6\xFB\x2A\xE3\xBA\x5B\x06\xAA\xF2\xCC\x83\xCF\x78\xFA\x72\xEC\x35\x75\xEA\x00\x3B\xD4\xA5\xF0\x30\x23\xC7\xA3\xE2\x8E\xE5\xD0\x86\x1F\x2C\xDB\xA3\xC9\x86\x29\x71\x90\xAB\x41\x44\x0A\x5F\xC4\x93\xDC\x19\xDC\xE5\xBF\xEC\xA3\xDD\xAB\x13\xCE\xA6\xBF\x9F\x8B\x25\x1C\x93\x21\x86\x73\x01\x85\x7E\x40\x4D\xEA\x01\xE4\x6E\x22\x9B\x28\x52\x9D\x9A\x8E\xB1\xB0\x10\x15\x4F\xB9\x87\x97\x6D\xE5\x82\x90\x0D\x30\x61\xE2\x78\xC4\x09\x67\x86\x9B\xD3\x07\x6C\x49\xD0\xB8\x95\x28\x39\x5E\xAF\x75\x1B\xC2\xE1\x74\xA5\xF9\x7D\xD0\x53\xCF\x77\x7F\x43\x96\x0D\x48\xE6\x57\x6C\x9F\x70\x78");

        SecurityLog::create([
            'admin_id' => \Auth::guard('admins')->user()->id,
            'method' => SecurityLog::CREATE_METHOD,
            'action' => SecurityLog::ACTION['download_pdf'],
            'action_id' => $chargeback->id,
        ]);

        return Pdf::loadView('pdfs.evidence', compact('chargeback', 'payments', 'items', 'currentPayment', 'paymentCommandsHistory'))
            ->stream('download.pdf');
    }

    public function spendinglimit()
    {
        if (!UsersController::hasRule('fraud', 'write')) {
            return redirect('/admin');
        }
        return view('admin.chargeback.spendinglimit');
    }

    public function spendinglimitSave(Request $r)
    {
        if (!UsersController::hasRule('fraud', 'write')) {
            return redirect('/admin');
        }

        Setting::query()->find(1)->update([
            'cb_limit' => $r->input('cb_limit'),
            'cb_limit_period' => $r->input('cb_limit_period'),
        ]);

        SecurityLog::create([
            'admin_id' => \Auth::guard('admins')->user()->id,
            'method' => SecurityLog::UPDATE_METHOD,
            'action' => SecurityLog::ACTION['spending_limit'],
        ]);

        return redirect('/admin/chargeback/spendinglimit');
    }
}
